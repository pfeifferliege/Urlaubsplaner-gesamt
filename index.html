<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Urlaubsplaner Taxi Pfeiffer</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6a0572;
    --secondary-color: #ab09a8;
    --text-color: #333;
    --white: #ffffff;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    --border-radius: 12px;
    --col-urlaub: #92e6b7;
    --col-krank: #ff7675;
    --col-frei: #ffeaa7; 
    --col-feiertag: #a7d9f7;
    --col-ferien: #f7e0a7;
    --col-weekend: #f2e7f8;
    --btn-export-bg: #004085; 
    --btn-import-bg: #d35400; 
  }

  body { font-family: 'Poppins', sans-serif; max-width: 100%; margin: 0; background: #f4f7f6; padding: 1.5rem; color: var(--text-color); box-sizing: border-box; }
  .card { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
  h1, h2, h3 { color: var(--primary-color); text-align: center; }
  
  .legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0 20px 0; font-size: 0.75rem; font-weight: 600; }
  .legend-item { display: flex; align-items: center; gap: 5px; background: #fff; padding: 4px 8px; border-radius: 10px; border: 1px solid #ddd; }
  .box { width: 14px; height: 14px; border-radius: 3px; }

  .admin-grid { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; padding: 10px 0; }
  .admin-grid div { flex: 0 1 auto; }
  .admin-grid input[type="text"] { width: 180px; }
  .admin-grid input[type="number"] { width: 80px; }
  
  .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; padding: 10px 0; }
  
  label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--primary-color); margin-bottom: 5px; }
  input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; box-sizing: border-box; }
  button { cursor: pointer; font-weight: bold; color: white; border: none; transition: 0.3s; }
  
  .btn-add { background: #28a745; width: auto; padding: 10px 20px; }
  .btn-save { background: #007bff; width: 100%; }
  .btn-action { background: var(--secondary-color); }

  .btn-export { background: var(--btn-export-bg); font-size: 1.1rem; padding: 15px !important; width: 100%; }
  .btn-import { background: var(--btn-import-bg); font-size: 1.1rem; padding: 15px !important; width: 100%; }

  .checkbox-group { display: flex; gap: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
  .checkbox-group label { display: flex; align-items: center; gap: 5px; color: #333; margin-bottom: 0; font-size: 0.8rem; width: auto; }
  .checkbox-group input { width: auto; }

  .collapsible { background-color: var(--primary-color); color: white; padding: 15px; width: 100%; border: none; text-align: left; font-weight: bold; border-radius: 12px; display: flex; justify-content: space-between; cursor: pointer; margin-bottom: 25px; }
  
  .content { padding: 15px; display: none; background: white; border: 2px solid var(--primary-color); border-top: none; border-radius: 0 0 12px 12px; margin-top: -25px; margin-bottom: 30px; }

  #calendarWrapper { overflow-x: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid #ddd; }
  table { border-collapse: collapse; table-layout: fixed; width: auto; }
  th, td { border: 1px solid #ddd; text-align: center; font-size: 0.65rem; width: 36px; min-width: 36px; height: 36px; position: relative; }
  .day-label { font-size: 0.5rem; color: #777; display: block; }
  .name-col { width: 220px !important; min-width: 220px !important; text-align: left; padding-left: 10px; font-weight: bold; position: sticky; left: 0; background: #fff; z-index: 10; border-right: 2px solid #aaa; }

  .bg-we { background-color: var(--col-weekend); }
  .bg-fe { background-color: var(--col-feiertag); font-weight: bold; }
  .bg-fr { background-color: var(--col-ferien); }
  .bg-ur { background-color: var(--col-urlaub); }
  .bg-kr { background-color: var(--col-krank); }
  .bg-ub { background-color: var(--col-frei); } 
  .ur-fr { background: linear-gradient(135deg, var(--col-urlaub) 50%, var(--col-ferien) 50%); }

  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
  .modal-content { background: white; margin: 5% auto; padding: 2rem; border-radius: 15px; width: 80%; max-width: 550px; position: relative; box-shadow: var(--shadow); }
  .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }

  @media print { 
    body * { visibility: hidden; }
    .modal-content, .modal-content * { visibility: visible; }
    .modal-content { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
    .no-print-modal { display: none; }
    .no-print { display: none !important; }
  }
</style>
</head>
<body>

<h1 class="no-print">Urlaubsplaner Taxi Pfeiffer</h1>

<button type="button" class="collapsible no-print">üë§ Mitarbeiter-Verwaltung & Spezifikationen <span>+</span></button>
<div class="content no-print">
  <div class="admin-grid">
    <div><label>Name</label><input type="text" id="newUserName" placeholder="Name"></div>
    <div><label>Anspruch</label><input type="number" id="newUserGesamt" value="30"></div>
    <div><label>Vorjahr</label><input type="number" id="newUserRest" value="0"></div>
    <div>
      <label>Spezifikation</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="specRS"> RS</label>
        <label><input type="checkbox" id="specL"> L</label>
        <label><input type="checkbox" id="specN" checked> N</label>
      </div>
    </div>
    <button class="btn-add" onclick="addUser()">Anlegen</button>
  </div>
</div>

<div class="card no-print">
  <div class="grid-form">
    <div><label>Mitarbeiter</label><select id="userSelect"><option value="">-- W√§hlen --</option></select></div>
    <div><label>Jahr</label><select id="yearSelect"></select></div>
    <div><label>Zeitraum</label><div style="display:flex; gap:5px;"><input type="date" id="dateFrom"><input type="date" id="dateTo"></div></div>
    <div><label>Typ</label>
      <div class="checkbox-group" style="background:white;">
        <label><input type="radio" name="absType" value="ur" checked> Urlaub</label>
        <label><input type="radio" name="absType" value="kr"> Krank</label>
        <label><input type="radio" name="absType" value="ub"> Frei</label>
      </div>
    </div>
    <div style="display:flex; gap:5px;"><button class="btn-save" onclick="requestUrlaub()">Speichern</button>
    <button style="background:#dc3545; width:50px; flex-shrink:0;" onclick="deleteUser()">üóëÔ∏è</button></div>
  </div>
</div>

<h2 id="calendarTitle">Urlaubskalender</h2>

<div class="legend">
  <div class="legend-item"><div class="box" style="background:var(--col-urlaub)"></div> Urlaub</div>
  <div class="legend-item"><div class="box" style="background:var(--col-krank)"></div> Krank</div>
  <div class="legend-item"><div class="box" style="background:var(--col-frei)"></div> Frei</div>
  <div class="legend-item"><div class="box" style="background:var(--col-feiertag)"></div> Feiertag (ST)</div>
  <div class="legend-item"><div class="box" style="background:var(--col-ferien)"></div> Ferien (ST)</div>
  <div class="legend-item"><div class="box" style="background:var(--col-weekend)"></div> WE</div>
</div>

<div id="calendarWrapper">
  <table id="calendarTable"></table>
</div>

<div class="card no-print" style="max-width: 450px; margin: 20px auto; border: 1px solid var(--primary-color);">
  <label style="text-align: center; font-weight: bold; display: block;">Statistik / Beleg drucken:</label>
  <select id="statUserSelect" onchange="showStatModal()"><option value="">-- Mitarbeiter w√§hlen --</option></select>
</div>

<div id="statModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalName">√úbersicht</h3>
    <div id="statDetails" style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;"></div>
    <div style="text-align: center;" class="no-print-modal">
      <button class="btn-action" onclick="window.print()">üñ®Ô∏è Beleg drucken</button>
    </div>
  </div>
</div>

<div style="text-align:center; margin-top:30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; margin-left: auto; margin-right: auto;" class="no-print">
  <button class="btn-export" onclick="exportData()">üíæ DATEN EXPORTIEREN</button>
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">üìÇ DATEN IMPORTIEREN</button>
  <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
</div>

<script>
const $ = id => document.getElementById(id);
let users = JSON.parse(localStorage.getItem('taxi_users') || '[]');
let urlaubPlan = JSON.parse(localStorage.getItem('taxi_plan') || '[]');

function getFeiertage(y) {
  const f = (m, d) => new Date(y, m, d);
  const o = calculateEaster(y);
  return [{d: f(0,1)}, {d: f(0,6)}, {d: new Date(y, o.m, o.d-2)}, {d: new Date(y, o.m, o.d+1)}, {d: f(4,1)}, {d: new Date(y, o.m, o.d+39)}, {d: new Date(y, o.m, o.d+50)}, {d: f(9,3)}, {d: f(9,31)}, {d: f(11,25)}, {d: f(11,26)}];
}
function calculateEaster(y) {
  const f=Math.floor, g=y%19, c=f(y/100), h=(c-f(c/4)-f((8*c+13)/25)+19*g+15)%30, i=(h-f(h/28)*(1-f(h/28))*(29/(h+1))*f((21-g)/11))%30, j=(y+f(y/4)+i+2-c+f(c/4))%7, l=i-j, m=3+f((l+40)/44), d=l+28-31*f(m/4);
  return {m: m-1, d: d};
}

const ferienDaten = {
  2025: [{s:"2025-07-03", e:"2025-08-13"}, {s:"2025-10-20", e:"2025-10-30"}, {s:"2025-12-22", e:"2025-12-31"}],
  2026: [{s:"2026-02-09", e:"2026-02-14"}, {s:"2026-04-06", e:"2026-04-11"}, {s:"2026-07-02", e:"2026-08-12"}]
};

function save() { localStorage.setItem('taxi_users', JSON.stringify(users)); localStorage.setItem('taxi_plan', JSON.stringify(urlaubPlan)); }

function addUser() {
  const name = $("newUserName").value; if(!name) return;
  users.push({ id: "u"+Date.now(), name, gesamt: parseInt($("newUserGesamt").value), rest: parseInt($("newUserRest").value), specs: { rs: $("specRS").checked, l: $("specL").checked, n: $("specN").checked } });
  save(); location.reload();
}

function requestUrlaub() {
  const uid = $("userSelect").value, v = $("dateFrom").value, b = $("dateTo").value, type = document.querySelector('input[name="absType"]:checked').value;
  if(!uid || !v || !b) return alert("Fehler!");
  const applicant = users.find(u => u.id === uid);
  const dS = new Date(v), dE = new Date(b);
  if (type === 'ur' && (applicant.specs.rs || applicant.specs.l)) {
    let conflictDaysCount = 0;
    for (let d = new Date(dS); d <= dE; d.setDate(d.getDate() + 1)) {
      const dsStr = d.toISOString().split('T')[0];
      const awayCount = urlaubPlan.filter(p => {
        const coll = users.find(u => u.id === p.uid);
        return coll && p.uid !== uid && p.type === 'ur' && dsStr >= p.v && dsStr <= p.b && ((applicant.specs.rs && coll.specs.rs) || (applicant.specs.l && coll.specs.l));
      }).length;
      if (awayCount >= 2) conflictDaysCount++;
    }
    if (conflictDaysCount > 3) {
      alert(`Buchung abgelehnt: Die √úberschneidung mit 2 anderen RS/L-Fahrern betr√§gt ${conflictDaysCount} Tage (max. 3 erlaubt).`);
      return;
    } else if (conflictDaysCount > 0) {
      if (!confirm(`Hinweis: Es gibt eine √úberschneidung von ${conflictDaysCount} Tagen mit 2 anderen RS/L-Fahrern. Speichern?`)) return;
    }
  }
  urlaubPlan.push({uid, v, b, type});
  save(); render();
}

function showStatModal() {
  const uid = $("statUserSelect").value; if(!uid) return;
  const u = users.find(x => x.id === uid);
  const y = parseInt($("yearSelect").value);
  let gen = 0;
  urlaubPlan.filter(p => p.uid === uid && p.type === 'ur').forEach(p => {
    let s = new Date(p.v), e = new Date(p.b);
    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) {
      if(d.getFullYear() === y && d.getDay() !== 0 && d.getDay() !== 6) gen++;
    }
  });
  $("modalName").textContent = u.name;
  $("statDetails").innerHTML = `<b>Jahr: ${y}</b><br><br>Anspruch: ${u.gesamt} Tage<br>Resturlaub: ${u.rest} Tage<br>-------------------------------<br>Genommen: ${gen} Tage<br><br><span style="font-size:1.3rem; color:var(--primary-color)"><b>Verbleibend: ${u.gesamt + u.rest - gen} Tage</b></span>`;
  $("statModal").style.display = "block";
}

function closeModal() { $("statModal").style.display = "none"; }

function render() {
  const y = parseInt($("yearSelect").value) || 2026;
  $("calendarTitle").textContent = `Urlaubskalender ${y}`;
  const table = $("calendarTable"); table.innerHTML = "";
  const ft = getFeiertage(y);
  const fer = ferienDaten[y] || [];
  const wdS = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];
  let h1 = "<tr><th class='name-col'></th>";
  for(let m=0; m<12; m++) h1 += `<th colspan="${new Date(y,m+1,0).getDate()}">${new Date(y,m).toLocaleString('de',{month:'short'})}</th>`;
  table.innerHTML += h1 + "</tr>";
  let h2 = "<tr><th class='name-col'>Mitarbeiter</th>";
  for(let m=0; m<12; m++) {
    for(let d=1; d<=new Date(y,m+1,0).getDate(); d++) {
      const date = new Date(y,m,d);
      h2 += `<th><span class="day-label">${wdS[date.getDay()]}</span>${d}</th>`;
    }
  }
  table.innerHTML += h2 + "</tr>";
  users.forEach(u => {
    let sp = (u.specs.rs?"RS ":"")+(u.specs.l?"L ":"")+(u.specs.n?"N":"");
    let row = `<tr><td class='name-col'>${u.name} <small>(${sp})</small></td>`;
    for(let m=0; m<12; m++) {
      for(let d=1; d<=new Date(y,m+1,0).getDate(); d++) {
        const date = new Date(y, m, d);
        const ds = date.toISOString().split('T')[0];
        const isFt = ft.some(f => f.d.getTime() === date.getTime());
        const isWe = date.getDay()===0 || date.getDay()===6;
        const isFr = fer.some(f => ds >= f.s && ds <= f.e);
        const p = urlaubPlan.find(x => x.uid === u.id && ds >= x.v && ds <= x.b);
        let cls = isFt ? "bg-fe" : (p ? (isFr && p.type==='ur' ? "ur-fr" : "bg-"+p.type) : (isWe ? "bg-we" : (isFr ? "bg-fr" : "")));
        row += `<td class="${cls}"></td>`;
      }
    }
    table.innerHTML += row + "</tr>";
  });
}

function deleteUser() {
  const uid = $("userSelect").value;
  if(uid && confirm("Mitarbeiter l√∂schen?")) { users = users.filter(x => x.id !== uid); urlaubPlan = urlaubPlan.filter(x => x.uid !== uid); save(); location.reload(); }
}

function exportData() {
  const now = new Date();
  const datum = now.toISOString().split('T')[0]; // YYYY-MM-DD
  const uhrzeit = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
  const fileName = `Urlaub_2026_backup_${datum}_${uhrzeit}.json`;
  
  const b = new Blob([JSON.stringify({users, urlaubPlan})], {type:"application/json"});
  const a = document.createElement("a"); 
  a.href=URL.createObjectURL(b); 
  a.download=fileName; 
  a.click();
}

function importData(e) {
  const r = new FileReader();
  r.onload = (ex) => {
    const d = JSON.parse(ex.target.result);
    localStorage.setItem('taxi_users', JSON.stringify(d.users));
    localStorage.setItem('taxi_plan', JSON.stringify(d.urlaubPlan));
    location.reload();
  };
  r.readAsText(e.target.files[0]);
}

function init() {
  const ys = $("yearSelect");
  for(let i=2025; i<=2026; i++) {
    let o = document.createElement("option"); o.value=i; o.textContent=i;
    if(i === 2026) o.selected = true;
    ys.appendChild(o);
  }
  users.forEach(u => {
    let o = document.createElement("option"); o.value=u.id; o.textContent=u.name;
    $("userSelect").appendChild(o.cloneNode(true));
    $("statUserSelect").appendChild(o.cloneNode(true));
  });
  ys.onchange = render;
  document.querySelector(".collapsible").onclick = function() {
    this.classList.toggle("active");
    const c = this.nextElementSibling;
    const isVisible = (c.style.display === "block");
    c.style.display = isVisible ? "none" : "block";
    this.style.marginBottom = isVisible ? "25px" : "10px";
  };
  render();
}
init();
</script>
</body>
</html>


